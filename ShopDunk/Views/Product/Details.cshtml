@model ShopDunk.Models.Product
@{
    ViewBag.Title = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var suggested = (List<ShopDunk.Models.Product>)ViewBag.SuggestedProducts;
    var reviews = (List<ShopDunk.Models.ProductReview>)ViewBag.Reviews;
    int reviewCount = ViewBag.ReviewCount ?? 0;

    // Lấy danh sách các tùy chọn duy nhất (Distinct)
    var uniqueStorages = Model.Variants?.Select(v => v.Storage).Distinct().ToList() ?? new List<string>();
    var uniqueColors = Model.Variants?.Select(v => v.Color).Distinct().ToList() ?? new List<string>();
}

<style>
    /* Style chung cho nút chọn */
    .option-btn {
        border: 1px solid #444;
        background-color: transparent;
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        margin-right: 10px;
        margin-bottom: 10px;
        min-width: 80px;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        position: relative;
    }

        .option-btn:hover {
            border-color: var(--accent-gold);
            background-color: rgba(240, 185, 11, 0.1);
            color: var(--accent-gold);
        }

        /* Class khi nút được chọn */
        .option-btn.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 1px var(--accent-gold);
            background-color: rgba(240, 185, 11, 0.15);
            color: var(--accent-gold);
            font-weight: bold;
        }

    .option-group-label {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
        color: #ccc;
    }

    .shake-animation {
        animation: shake 0.5s;
    }

    @@keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }

        20%, 60% {
            transform: translateX(-5px);
        }

        40%, 80% {
            transform: translateX(5px);
        }
    }
</style>

<div class="row my-5">
    <div class="col-md-6 mb-4 text-center">
        <div class="card border-0 shadow-sm p-3" style="background-color: var(--dark-card);">
            <img src="@Model.ImageBase64" class="img-fluid" style="max-height: 500px; object-fit: contain;" />
        </div>
    </div>

    <div class="col-md-6">
        <h2 class="fw-bold mb-3 text-light">@Model.Name</h2>

        <h3 class="fw-bold mb-4" id="displayPrice" style="color: var(--accent-gold);">
            @Model.Price.ToString("N0") ₫
        </h3>

        @using (Html.BeginForm("Add", "Cart", FormMethod.Get))
        {
            @Html.Hidden("id", Model.ProductID)
            @Html.Hidden("variantId", "", new { id = "selectedVariantId" })

            if (Model.Variants != null && Model.Variants.Any())
            {
                <div class="mb-3">
                    <label class="option-group-label">Dung lượng:</label>
                    <div class="d-flex flex-wrap">
                        @foreach (var storage in uniqueStorages)
                        {
                            <button type="button" class="option-btn btn-storage"
                                    onclick="selectStorage(this, '@Html.Raw(storage)')">
                                @storage
                            </button>
                        }
                    </div>
                </div>

                <div class="mb-4">
                    <label class="option-group-label">Màu sắc:</label>
                    <div class="d-flex flex-wrap">
                        @foreach (var color in uniqueColors)
                        {
                            <button type="button" class="option-btn btn-color"
                                    onclick="selectColor(this, '@Html.Raw(color)')">
                                @color
                            </button>
                        }
                    </div>
                </div>
                <hr class="my-4 border-secondary" />
                <h5 class="fw-bold text-light">Đặc điểm nổi bật</h5>
                <p class="text-muted" style="white-space: pre-line;">@Model.Description</p>
                <hr class="my-4 border-secondary" />

                <p class="mb-3 text-light">Tình trạng: <span id="stockStatus" class="fw-bold text-muted">Vui lòng chọn phân loại</span></p>
            }
            else
            {
                <p class="mb-3 text-light">Tình trạng: <span class="fw-bold" style="color: var(--accent-gold);">@((Model.Stock > 0) ? "Còn hàng" : "Hết hàng")</span></p>
            }

            <div class="d-grid gap-2">
                <button type="submit" id="btnAddToCart" class="btn btn-outline-primary btn-lg rounded-pill" onclick="return checkVariant()">
                    <i class="fas fa-shopping-cart me-2"></i> Thêm vào giỏ hàng
                </button>
            </div>

            <small class="text-danger mt-2" id="selectWarning" style="display:none; font-weight:bold;">
                <i class="fas fa-exclamation-circle"></i> Vui lòng chọn đủ Dung lượng và Màu sắc!
            </small>
        }
    </div>
</div>

<hr class="my-5 border-secondary" />

@* =============== KHU VỰC ĐÁNH GIÁ VÀ FORM SUBMIT (FIXED) =============== *@
<div class="row">
    <div class="col-md-7">
        <h3 class="category-title mb-3 text-light">Đánh giá (@reviewCount)</h3>

        @if (reviews != null && reviews.Any())
        {
            foreach (var r in reviews)
            {
                <div class="card mb-3" style="background-color: var(--dark-card); border-color: var(--border-color);">
                    <div class="card-body">
                        <h6><strong>@r.User.Username</strong> - <span class="text-muted">@r.ReviewDate.ToString("dd/MM/yyyy")</span></h6>
                        <div class="text-warning">
                            @for (int i = 1; i <= 5; i++)
                            {<i class="fas fa-star @(i<=r.Rating?"":"text-muted")"></i>}
                        </div>
                        <p class="mt-2">@r.Comment</p>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
        }
    </div>

    <div class="col-md-5">
        <h3 class="category-title mb-3 text-light">Viết đánh giá của bạn</h3>
        @if (Session["UserID"] != null)
        {
            using (Html.BeginForm("AddReview", "Product", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("ProductID", Model.ProductID)

                <div class="mb-3">
                    <label class="form-label text-light">Bạn đánh giá mấy sao?</label>
                    <div class="star-rating-input">
                        <input type="radio" id="star5" name="Rating" value="5" required /><label for="star5" title="5 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star4" name="Rating" value="4" /><label for="star4" title="4 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star3" name="Rating" value="3" /><label for="star3" title="3 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star2" name="Rating" value="2" /><label for="star2" title="2 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star1" name="Rating" value="1" /><label for="star1" title="1 sao"><i class="fas fa-star"></i></label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="Comment" class="form-label text-light">Nội dung đánh giá (Tùy chọn)</label>
                    <textarea name="Comment" id="Comment" class="form-control" rows="4"></textarea>
                </div>

                <button type="submit" class="btn btn-primary rounded-pill">Gửi đánh giá</button>

                @* Hiển thị thông báo (nếu có) *@
                if (TempData["ReviewError"] != null)
                {
                    <div class="alert alert-danger mt-3">@TempData["ReviewError"]</div>
                } @* <--- THÊM DẤU ĐÓNG KHỐI NÀY VÀO *@

                if (TempData["ReviewSuccess"] != null)
                {
                    <div class="alert alert-success mt-3">@TempData["ReviewSuccess"]</div>
                }
            }
        }
        else
        {
            <p class="text-light"><a href="@Url.Action("Login", "Account", new { returnUrl = Request.Url.PathAndQuery })">Đăng nhập</a> để đánh giá sản phẩm này.</p>
        }
    </div>
</div>

<hr class="my-5 border-secondary" />

@* =============== KHU VỰC GỢI Ý SẢN PHẨM KHÁC =============== *@
@if (suggested != null && suggested.Any())
{
    <div class="category-section">
        <h3 class="category-title mb-3 text-light">Bạn có thể thích</h3>

        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            @foreach (var p in suggested)
            {
                @Html.Partial("~/Views/Shared/_ProductCard.cshtml", p)
            }
        </div>
    </div>
}


<script>
    // --- 1. Dữ liệu Variants JSON (Đã fix lỗi Encoding) ---
    var allVariants = [
        @foreach (var v in Model.Variants)
        {
            @: { id: "@v.VariantID", color: "@Html.Raw(v.Color)", storage: "@Html.Raw(v.Storage)", price: @((long)v.Price), stock: @v.Stock },
        }
    ];

    // Biến lưu lựa chọn hiện tại
    var currentStorage = "";
    var currentColor = "";

    // Hàm chọn Dung lượng
    function selectStorage(btn, storage) {
        document.querySelectorAll('.btn-storage').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentStorage = storage;
        findMatchingVariant();
    }

    // Hàm chọn Màu sắc
    function selectColor(btn, color) {
        document.querySelectorAll('.btn-color').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentColor = color;
        findMatchingVariant();
    }

    // Hàm tìm biến thể khớp với cả 2 lựa chọn (CORE LOGIC)
    function findMatchingVariant() {
        document.getElementById('selectWarning').style.display = 'none';

        if (currentStorage !== "" && currentColor !== "") {

            var match = allVariants.find(v => v.storage === currentStorage && v.color === currentColor);

            if (match) {
                // TÌM THẤY: Cập nhật giao diện
                document.getElementById('displayPrice').innerText = match.price.toLocaleString('vi-VN') + ' ₫';
                document.getElementById('selectedVariantId').value = match.id;

                var btnAdd = document.getElementById('btnAddToCart');
                var stockLabel = document.getElementById('stockStatus');

                if (match.stock > 0) {
                    btnAdd.disabled = false;
                    btnAdd.innerText = "Thêm vào giỏ hàng";
                    stockLabel.innerText = "Còn hàng (" + match.stock + ")";
                    stockLabel.className = "fw-bold";
                    stockLabel.style.color = "var(--accent-gold)";
                } else {
                    btnAdd.disabled = true;
                    btnAdd.innerText = "Tạm hết hàng";
                    stockLabel.innerText = "Hết hàng";
                    stockLabel.className = "fw-bold text-danger";
                    stockLabel.style.color = "";
                }
            } else {
                // KHÔNG TÌM THẤY (Lỗi kết hợp)
                var stockLabel = document.getElementById('stockStatus');
                stockLabel.innerText = "Phiên bản này không tồn tại";
                stockLabel.className = "fw-bold text-warning";
                stockLabel.style.color = "";

                document.getElementById('selectedVariantId').value = "";
                document.getElementById('btnAddToCart').disabled = true;
            }
        }
    }

    // Hàm kiểm tra trước khi submit (Cho phép submit nếu không có variants)
    function checkVariant() {
        var hasOptions = document.querySelectorAll('.option-btn').length > 0;
        var id = document.getElementById('selectedVariantId').value;

        if (hasOptions && id === "") {
             var warning = document.getElementById('selectWarning');
             if(warning) {
                 warning.style.display = 'block';
                 warning.classList.add('shake-animation');
             }
             return false;
        }

        // Nếu không có options (sản phẩm thường) -> Cho phép submit
        return true;
    }
</script>