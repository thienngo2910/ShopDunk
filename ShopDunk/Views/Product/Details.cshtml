@model ShopDunk.Models.Product
@{
    ViewBag.Title = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var suggested = (List<ShopDunk.Models.Product>)ViewBag.SuggestedProducts;
    var reviews = (List<ShopDunk.Models.ProductReview>)ViewBag.Reviews;
    double averageRating = ViewBag.AverageRating;
    int reviewCount = ViewBag.ReviewCount;
}

<div class="row">
    <div class="col-md-6 mb-4">
        <img src="@Model.ImageBase64" class="img-fluid" />
    </div>

    <div class="col-md-6">
        <h2 class="fw-bold">@Model.Name</h2>

        <p class="fs-4 fw-bold text-warning" id="displayPrice">
            @Model.Price.ToString("N0") ₫
        </p>

        @using (Html.BeginForm("Add", "Cart", FormMethod.Get)) // Gửi sang Cart/Add
        {
            <input type="hidden" name="id" value="@Model.ProductID" />

            if (Model.Variants != null && Model.Variants.Any())
            {
                <div class="mb-3">
                    <label class="fw-bold">Chọn phiên bản:</label>
                    <select name="variantId" id="variantSelect" class="form-select bg-dark text-light border-secondary">
                        <option value="" data-price="@Model.Price">Mặc định</option>
                        @foreach (var v in Model.Variants)
                        {
                            <option value="@v.VariantID" data-price="@v.Price">
                                @v.Color - @v.Storage - @v.Price.ToString("N0") ₫
                            </option>
                        }
                    </select>
                </div>
            }

            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-shopping-cart me-2"></i> Thêm vào giỏ
            </button>
        }

        <hr />
        <p class="text-light" style="white-space: pre-line;">@Model.Description</p>
    </div>
</div>

<script>// Script đơn giản để đổi giá khi chọn dropdown
    document.getElementById('variantSelect')?.addEventListener('change', function() {
        var selectedOption = this.options[this.selectedIndex];
        var price = selectedOption.getAttribute('data-price');
        // Format tiền tệ (đơn giản)
        var formattedPrice = parseFloat(price).toLocaleString('vi-VN') + ' ₫';
        document.getElementById('displayPrice').innerText = formattedPrice;
    });</script>

<hr class="my-5" style="border-color: var(--border-color);" />

@* --- KHU VỰC ĐÁNH GIÁ --- *@
<div class="row">
    <div class="col-md-7">
        <h3 class="category-title mb-3">Đánh giá của khách hàng (@reviewCount)</h3>
        @if (!reviews.Any())
        {
            <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
        }
        else
        {
            foreach (var review in reviews)
            {
                <div class="mb-4" style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                    <strong>@(review.User?.Username ?? "Người dùng")</strong>
                    <span class="text-muted ms-2" style="font-size: 0.9rem;">@review.ReviewDate.ToString("dd/MM/yyyy")</span>
                    <div class="star-rating-display my-1">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <i class="fas fa-star @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(review.Comment))
                    {
                        <p style="white-space: pre-line;">@review.Comment</p>
                    }
                </div>
            }
        }
    </div>

    <div class="col-md-5">
        <h3 class="category-title mb-3">Viết đánh giá của bạn</h3>
        @if (Session["UserID"] != null)
        {
            using (Html.BeginForm("AddReview", "Product", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("ProductID", Model.ProductID)

                <div class="mb-3">
                    <label class="form-label">Bạn đánh giá mấy sao?</label>
                    <div class="star-rating-input">
                        <input type="radio" id="star5" name="Rating" value="5" required /><label for="star5" title="5 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star4" name="Rating" value="4" /><label for="star4" title="4 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star3" name="Rating" value="3" /><label for="star3" title="3 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star2" name="Rating" value="2" /><label for="star2" title="2 sao"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star1" name="Rating" value="1" /><label for="star1" title="1 sao"><i class="fas fa-star"></i></label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="Comment" class="form-label">Nội dung đánh giá (Tùy chọn)</label>
                    <textarea name="Comment" id="Comment" class="form-control" rows="4"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Gửi đánh giá</button>

                @* --- SỬA LỖI: Đổi tên TempData --- *@
                if (TempData["ReviewError"] != null)
                {
                    <div class="alert alert-danger mt-3">@TempData["ReviewError"]</div>
                }
                if (TempData["ReviewSuccess"] != null)
                {
                    <div class="alert alert-success mt-3">@TempData["ReviewSuccess"]</div>
                }
            }
        }
        else
        {
            @* --- CẬP NHẬT (Thêm new { returnUrl = ... }) --- *@
            <p><a href="@Url.Action("Login", "Account", new { returnUrl = Request.Url.PathAndQuery })">Đăng nhập</a> để đánh giá sản phẩm này.</p>
        }

    </div>
</div>

@* --- KHU VỰC GỢI Ý SẢN PHẨM KHÁC --- *@
@if (suggested != null && suggested.Any())
{
    <hr class="my-5" style="border-color: var(--border-color);" />

    <div class="category-section">
        <h3 class="category-title mb-3">Bạn có thể thích</h3>

        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            @foreach (var p in suggested)
            {
                @Html.Partial("~/Views/Shared/_ProductCard.cshtml", p)
            }
        </div>
    </div>
}